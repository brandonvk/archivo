<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Turnado</title>
    <link rel="stylesheet" href="../css/plugin/bootstrap/bootstrap.min.css" >
    <link rel="stylesheet" href="../css/plugin/iconic-bootstrap/font/css/open-iconic-bootstrap.min.css" >
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.0/font/css/open-iconic-bootstrap.min.css" /> -->
    <style media="screen">
      body{
        margin-left: 1em;
        margin-right:  1em;
      }
      div{
        margin-top:0.5em;
      }
      .titulo{
        text-align: center;
      }
      .agregar{
        text-align: right;
        /* margin-right:0px; */
      }
      .formModal{
        margin-left: 1em;
        margin-right:  1em;
      }
      .campoFecha{
        /* margin-left: 2em; */
      }
    </style>
  </head>
  <body>
    <div class="row">
      <!-- <img src="../css/plugin/iconic-bootstrap/svg/cog.svg" alt="icon name"> -->
      <!-- <span class="oi oi-icon-star" title="icon star" aria-hidden="true"></span> -->

      <div class="col col-md-12 col-xs-12 col-sm-12">
        <span class="oi oi-data-transfer-upload"></span>
        <h2 class="titulo">Turnado</h2>
      </div>
      <div class="col col-md-12 col-xs-12 col-sm-12 agregar">
        <button id="addTurno" class="btn btn-success " type="button" name="button" >Agregar</button>
      </div>
      <div class="col col-md-12 col-xs-12 col-sm-12 main">
        <div class="col col-md-12 col-xs-12 col-sm-12 table">

        </div>
        <div class="col col-md-12 col-xs-12 col-sm-12 page">

        </div>
      </div>
    </div>
    <!-- modal -->
    <!-- <button type="button" class="btn btn-primary" >Open modal for @mdo</button> -->

    <!-- <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">New message</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="col-form-label">Recipient:</label>
                <input type="text" class="form-control" id="recipient-name">
              </div>
              <div class="form-group">
                <label for="message-text" class="col-form-label">Message:</label>
                <textarea class="form-control" id="message-text"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Send message</button>
          </div>
        </div>
      </div>
    </div> -->
  </body>
  <script type="text/javascript" src="../js/jquery-3.3.1.js">  </script>
  <script type="text/javascript" src="../js/popper.min.js">  </script>
  <script type="text/javascript" src="../js/bootstrap.min.js">  </script>
  <script type="text/javascript">
  // $("#exampleModal").modal("show");
  // setTimeout(function(){
  //   console.log("cerrar");
  //   $("#exampleModal").modal("hide");
  // },1000*5)
    let html={
      modal_head:(id,title) => {
        return head=`<div class="modal fade" id="${id}" tabindex="-1" role="dialog" aria-labelledby="${id}Label" aria-hidden="true">`+
          '<div class="modal-dialog" role="document">'+
            '<div class="modal-content">'+
              '<div class="modal-header">'+
                `<h5 class="modal-title" id="${id}Label">${title}</h5>`+
                '<button type="button" class="close" data-dismiss="modal" aria-label="Close">'+
                  '<span aria-hidden="true">&times;</span>'+
                '</button>'+
              '</div>';
      },modal_foot:(id)=>{
        return foot='<div class="modal-footer">'+
          `<button id="${id}Cancelar" type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>`+
          `<button id="${id}Aceptar" type="button" class="btn btn-primary">Aceptar</button>`+
        '</div>';
      },modal_form:(id,title,html_content) => `${html.modal_head(id,title)}${html_content}${html.modal_foot(id)}`,
      modal_alert:(id,title,html_content) => `${html.modal_head(id,title)}${html_content}${html.modal_foot(id)}`,
      modal:{},
      modal_add:(id,title,type,html_content,cll)=>{
        if(html.modal[id]){
          html.modal_show(id)
        }else{
          if (type=="form") html.modal[id]=html.modal_form(id,title,html_content,cll);
          if (type=="alert") html.modal[id]=html.modal_alert(id,title,html_content,cll);
          $("body").append(html.modal[id]);
          $(`#${id}Aceptar`).click((e)=>cll(true));
          $(`#${id}Cancelar`).click((e)=>cll(false));
        }

        // $("body").load();
        return this;
      },modal_show:(id,cll)=>{
        // console.log(html.modal[id]);
        cll && cll();
        $(`#${id}`).modal("show");
      },dropdown:(opt,id)=>{
        let dropdown_str=`<div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span class="oi" data-glyph="icon-name" title="icon name" aria-hidden="true"></span>
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">`;
        for (var opt_key in opt) {
            dropdown_str+=`<a class="dropdown-item" href="#" onClick="turno.opt['${opt_key}'](${id})">${opt_key}</a>`;
        }
        dropdown_str+=`</div>
      </div>`;
      return dropdown_str;
      }
    }
    turno={
      opt:{
        editar:(id)=>{
          // console.log("editar",id,turno.rows[id]);
          html.modal_show("turno",()=>{

            $(`#formturno`)[0].reset();
            if(datos=turno.rows[id]){
              $(".modal-title").text("Editar turno");
              $(`#${id} form`).append(`<input value="${datos["id_turno"]}" type="hidden" name="id_turno">`);
              datos["action"]="edit";
              if(datos["fecha_entrega"]){
                let fecha = datos["fecha_entrega"].split("-")
                datos["dd"]=fecha.pop()
                datos["mm"]=fecha.pop()
                datos["aaaa"]=fecha.pop()
              }
              for (var dato in datos) {
                $(`#${dato}`).val(datos[dato])
              }
            }
          });
        },eliminar:(id)=>{
          html.modal_add("elimturno","Eliminar turno",'alert','¿Esta seguro que desea eliminar este registro?',(rs)=>{
            console.log("quiso eliminar?",rs);
            if(rs){
              $.ajax({
                url:"../../class/Turno.php",
                type:'post',
                data:{
                  action:"delete",
                  token:"Asndvdha$ua334baxhd.nshshqdlfg",
                  id:turno.rows[id].id_turno
                },success:(rows)=>{
                  $(`#elimturno`).modal("hide");
                  return turno.load(1);
                },error:(err) => {
                  $(`#elimturno`).modal("hide");
                  return console.error("Error al eliminar",err);
                }
              })
            }
          });
          html.modal_show("elimturno")
        }
      },
      get:(page,call)=>{
        $.ajax({
          url:"../../class/Turno.php",
          type:'post',
          data:{
            action:"getRows",
            page
          },success:(rows)=>{
            return call(null,JSON.parse(rows));
          },error:(err) => {
            return call(err);
          }
        })
      },table:(rows)=>{
        let table_header=['Opciones'];

        let table_lan={fecha_entrega:"Fecha de entrega",entrega:"Persona que entrego",tipo_documento:"Tipo de documento",descripcion:"Descripción",turnado:"Persona que se turno."};

        let table_body="";

        for(row in rows){
          table_body+=`<tr>`;
          table_body+=`<td>${html.dropdown(turno.opt,row)}</td>`
          for(campo in rows[row]){
            // console.log(campo);
            if(table_header.indexOf(table_lan[campo])==-1&&table_lan[campo]) table_header.push(table_lan[campo])
            if(table_lan[campo])table_body+=`<td>${rows[row][campo]}</td>`;
          }
          table_body+=`</tr>`;
        }
        $(".main .table").html(`<table class="table">
          <thead><tr><td>${table_header.join("</td><td>")}</td></tr></thead>
          <tbody>${table_body}</tbody></table>`);
      },page:(maxlength,view) => {

      },load:(pag) => {
        turno.get(pag,(err,rows) => {
          if(err) return console.error(err);
          turno.rows=rows.rows;
          turno.table(rows.rows);
          turno.page(rows.maxlength,10);
        })
      }
    }
    turno.load(1);
    html.modal_add("turno","Agregar turno",'form',
    `<!--<div><h1>con botas</h1></div>-->
    <form id="formturno" class="formModal" action="jacascript:;">
    <div class="form-group">
      <label>Entregado por:</label>
      <input id="entrega" name="entrega" type="text" class="form-control">
    </div>
    <div class="form-group">
      <label>Fecha de entrega:</label>
      <div class="row">
        <div class="col col-md-4 col-xs-4 col-sm-4">
          <input placeholder="dd" id="dd" name="dd" type="number" class="form-control campoFecha">
        </div>
        <div class="col col-md-4 col-xs-4 col-sm-4">
          <input placeholder="mm" id="mm" name="mm" type="number" class="form-control campoFecha">
        </div>
        <div class="col col-md-4 col-xs-4 col-sm-4">
          <input placeholder="aaaa" id="aaaa" name="aaaa" type="number" class="form-control campoFecha">
        </div>
      </div>
    </div>
    <div class="form-group">
      <label>Tipo de documento:</label>
      <input id="tipo_documento" name="tipo_documento" type="text" class="form-control">
    </div>
    <div class="form-group">
      <label>Descripción:</label>
      <textarea class="form-control" name="descripcion" id="descripcion"></textarea>
    </div>
    <div class="form-group">
      <label>Turnado:</label>
      <input id="turnado" name="turnado" type="text" class="form-control">
    </div>
    <input id="action" name="action" type="hidden" value="add" class="form-control">
    </form>
    `,(quest)=>{
      if(quest) {
        $("#formturno").submit(function(){
          var form = new FormData($('#formturno')[0]);
          console.log("data",form);
          $.ajax({
            url:"../../class/Turno.php",
            type:'post',
            dataType: 'text',
            contentType: false,
            processData: false,
            data:form,
            success:(succ)=>{
              console.log(null,JSON.parse(succ));
              turno.load(1);
              $(`#turno`).modal("hide");
              // return call(null,JSON.parse(succ));
            },error:(err) => {
              console.log(err);
              // return call(err);
            }
          })
        }());
        // $("#turno").modal("hide")
      }
    })
    $("#addTurno").click((e)=>html.modal_show("turno",()=>{
      $(`#formturno`)[0].reset();
      $("[name=id_turno]").remove();
      $("[name=action]").val("add");
    }))

  </script>
</html>
